(function(){var b=null;this.Milkbox=new Class({Implements:[Options,Events],options:{overlayOpacity:0.7,marginTop:50,initialWidth:250,initialHeight:250,fileboxBorderWidth:"0px",fileboxBorderColor:"#000000",fileboxPadding:"0px",resizeDuration:0.5,resizeTransition:"sine:in:out",autoPlay:!1,autoPlayDelay:7,removeTitle:!0,autoSize:!0,autoSizeMaxHeight:0,centered:!1,imageOfText:"/",onXmlGalleries:function(){},onClosed:function(){},onFileReady:function(){}},initialize:function(a){if(b)return b;b=this;this.setOptions(a);
this.autoPlayBkup={autoPlayDelay:this.options.autoPlayDelay,autoPlay:this.options.autoPlay};this.fullOptionsBkup={};this.galleries=[];this.formElements=[];this.paused=this.busy=!1;this.closed=!0;this.externalGalleries=[];this.singlePageLinkId=0;this.loadedImages=[];this.getPageGalleries();this.galleries.length!=0&&this.prepare(!0)},prepare:function(a){a&&this.checkFormElements();this.prepareHTML();this.prepareEventListeners();this.activated=!0},open:function(a,c){var d;this.activated||this.prepare(!0);
var b=instanceOf(a,MilkboxGallery)?a:this.getGallery(a);if(!b)return!1;typeOf(c)!=="number"&&(d=b.get_index_of(c),d!==-1&&(c=d));d=parseInt(c,10);isNaN(d)&&(d=0);this.closed=!1;var f=b.get_item(d);if(!f)return!1;this.currentGallery=b;this.currentIndex=d;this.hideFormElements();this.display.set_mode(this.currentGallery.type);this.display.appear();(this.options.autoPlay||b.options.autoplay)&&this.startAutoPlay(!0);this.loadFile(f,this.getPreloads());return!0},close:function(a){a&&this.display.disappear();
this.showFormElements();this.pauseAutoPlay();this.stopLoadingCheck();this.currentFile=this.currentIndex=this.currentGallery=null;this.fileReady=this.paused=this.busy=!1;this.closed=!0;this.fireEvent("close")},startAutoPlay:function(a){var c=this.currentGallery.options.autoplay_delay||this.options.autoPlayDelay;c<this.options.resizeDuration*2&&(c=this.options.resizeDuration*2);var d=function(){this.removeEvent("fileReady",d);this.intId=this.navAux.periodical(c*1E3,this,[null,"next"])};a?this.addEvent("fileReady",
d):this.intId=this.navAux.periodical(c*1E3,this,[null,"next"]);this.paused=!1},pauseAutoPlay:function(){if(this.intId)clearInterval(this.intId),this.intId=null;this.paused=!0},setAutoPlay:function(a){(typeOf(a)=="object"?[a]:a).each(function(a){var d=this.getGallery(a.gallery);if(d){var b=a.autoplay==!0?a.autoplay:!1;d.setOptions({autoplay:b,autoplay_delay:a.delay&&b?a.delay:this.options.autoPlayDelay}).refresh()}},this)},openWithFile:function(a,c){this.activated||this.prepare();c&&this.refreshDisplay(c,
!0);this.open(new MilkboxGallery([a]),0)},getPreloads:function(){var a=this.currentGallery.items,c=this.currentIndex;if(a.length==1)return null;var b=c!=a.length-1?a[c+1]:a[0];a=c!=0?a[c-1]:a[a.length-1];return a==b?[a]:[a,b]},loadFile:function(a,c){this.fileReady=!1;this.display.clear_content();this.display.hide_bottom();this.checkFileType(a,"swf")?this.loadSwf(a):this.checkFileType(a,"html")?this.loadHtml(a):this.loadImage(a);this.checkFileType(a,"swf")||this.startLoadingCheck();c&&this.preloadFiles(c)},
startLoadingCheck:function(){var a=0;if(!this.loadCheckerId)this.loadCheckerId=function(){a+=1;a>5&&(this.loadCheckerId&&this.display.show_loader(),this.stopLoadingCheck())}.periodical(100,this)},stopLoadingCheck:function(){clearInterval(this.loadCheckerId)},preloadFiles:function(a){a.each(function(a){!this.checkFileType(a,"swf")&&!this.checkFileType(a,"html")&&this.preloadImage(a.href)},this)},preloadImage:function(a){this.loadedImages.contains(a)||new Asset.image(a,{onLoad:function(){this.loadedImages.push(a)}.bind(this)})},
loadImage:function(a){var c=a.href;new Asset.image(c,{onLoad:function(b){this.loadedImages.contains(c)||this.loadedImages.push(c);this.loadComplete(b,a.caption)}.bind(this)})},loadSwf:function(a){var c=new Swiff(a.href,{width:a.size.width,height:a.size.height,vars:a.vars,params:{wMode:"opaque",swLiveConnect:"false"}});this.loadComplete($(c),a.caption)},loadHtml:function(a){var c=a.vars?"?"+Object.toQueryString(a.vars):"";c=new Element("iframe",{src:a.href+c,frameborder:0,styles:{border:"none"}});
a.size&&c.set({width:a.size.width,height:a.size.height});this.loadComplete(c,a.caption)},loadComplete:function(a,c){if(!this.closed){this.fileReady=!0;this.stopLoadingCheck();this.currentFile=a;var b;b=function(){this.display.ready&&(this.currentGallery.items!=null&&this.display.show_file(a,c,this.currentIndex+1,this.currentGallery.items.length),clearInterval(b))}.periodical(100,this);this.fireEvent("fileReady")}},checkFileType:function(a,c){var b=typeOf(a)!="string"?a.href:a;return b.split("?")[0].test(RegExp(".("+
c+")$","i"))},getPageGalleries:function(){var a=[];$$("a[data-milkbox]").each(function(c){var b=c.get("data-milkbox");b=="single"?this.galleries.push(new MilkboxGallery(c,{name:"single"+this.singlePageLinkId++})):a.contains(b)||a.push(b)},this);a.each(function(a){this.galleries.push(new MilkboxGallery($$("a[data-milkbox="+a+"]"),{name:a}))},this);this.options.autoPlay&&this.galleries.each(function(a){a.setOptions({autoplay:this.options.autoPlay,autoplay_delay:this.options.autoPlayDelay})})},reloadPageGalleries:function(){this.removePageGalleryEvents();
this.galleries=this.galleries.filter(function(a){a.external||a.clear();return a.external});this.getPageGalleries();this.addPageGalleriesEvents();this.activated||this.prepare(!0)},resetExternalGalleries:function(a){this.galleries=this.galleries.filter(function(a){a.external&&a.clear();return!a.external});a&&(typeOf(a)=="array"?a:[a]).each(function(a){this.addGalleries(a)},this)},addGalleries:function(a){this.activated||this.prepare(!0);typeOf(a)=="string"&&a.split("?")[0].test(/\.(xml)$/i)?this.loadXml(a):
this.setObjectGalleries(a);this.activated||this.prepare(!0)},loadXml:function(a){(new Request({method:"get",autoCancel:!0,url:a,onRequest:function(){}.bind(this),onSuccess:function(a){a=a.replace(/(<a.+)\/>/gi,"$1></a>");this.setXmlGalleries(new Element("div",{html:a}))}.bind(this),onFailure:function(){alert("Milkbox :: loadXml: XML file path error or local Ajax test: please test xml galleries on-line")}})).send()},setXmlGalleries:function(a){a.getElements(".gallery").each(function(a){var b={name:a.getProperty("name"),
autoplay:Boolean(a.getProperty("autoplay")),autoplay_delay:Number(a.getProperty("autoplay_delay"))};a=a.getChildren("a").map(function(a){return{href:a.href,size:a.get("data-milkbox-size"),title:a.get("title")}},this);this.galleries.push(new MilkboxGallery(a,b))},this);this.fireEvent("xmlGalleries")},setObjectGalleries:function(a){(typeOf(a)=="array"?a:[a]).each(function(a){this.galleries.push(new MilkboxGallery(a.files,{name:a.name,autoplay:a.autoplay,autoplay_delay:a.autoplay_delay}))},this)},getGallery:function(a){return this.galleries.filter(function(c){return c.name==
a},this)[0]||null},prepareHTML:function(){this.display=new MilkboxDisplay({initialWidth:this.options.initialWidth,initialHeight:this.options.initialHeight,overlayOpacity:this.options.overlayOpacity,marginTop:this.options.marginTop,fileboxBorderWidth:this.options.fileboxBorderWidth,fileboxBorderColor:this.options.fileboxBorderColor,fileboxPadding:this.options.fileboxPadding,resizeDuration:this.options.resizeDuration,resizeTransition:this.options.resizeTransition,centered:this.options.centered,autoSize:this.options.autoSize,
autoSizeMaxHeight:this.options.autoSizeMaxHeight,imageOfText:this.options.imageOfText})},refreshDisplay:function(a,c){if(this.activated){var b=this.display.options,e=Object.merge({},b,a);this.display&&this.display.clear();this.display=new MilkboxDisplay(e);this.addDisplayEvents();this.options_bkup=c?b:null}},checkFormElements:function(){this.formElements=$$("select, textarea");if(this.formElements.length!=0)this.formElements=this.formElements.map(function(a){a.store("visibility",a.getStyle("visibility"));
a.store("display",a.getStyle("display"));return a})},hideFormElements:function(){this.formElements.length!=0&&this.formElements.each(function(a){a.setStyle("display","none")})},showFormElements:function(){this.formElements.length!=0&&this.formElements.each(function(a){a.setStyle("visibility",a.retrieve("visibility"));a.setStyle("display",a.retrieve("display"))})},addPageGalleriesEvents:function(){this.galleries.filter(function(a){return!a.external}).each(function(a){a.items.each(function(b){b.element.addEvent("click",
function(d){d.preventDefault();this.open(a.name,a.get_index_of(b))}.bind(this))},this)},this)},removePageGalleryEvents:function(){this.galleries.filter(function(a){return!a.external}).each(function(a){a.items.each(function(a){a.element.removeEvents("click")})})},addDisplayEvents:function(){this.display.addEvent("nextClick",function(){this.navAux(!0,"next")}.bind(this));this.display.addEvent("prevClick",function(){this.navAux(!0,"prev")}.bind(this));this.display.addEvent("playPauseClick",function(){this.paused?
this.startAutoPlay():this.pauseAutoPlay();this.display.set_paused(this.paused)}.bind(this));this.display.addEvent("disappear",function(){this.options_bkup&&this.refreshDisplay(this.options_bkup);this.close(!1)}.bind(this));this.display.addEvent("resizeComplete",function(){this.busy=!1}.bind(this))},prepareEventListeners:function(){this.addPageGalleriesEvents();this.addDisplayEvents();window.addEvent("resize",function(){this.display.ready&&this.display.resetOverlaySize()}.bind(this));window.document.addEvent("keydown",
function(a){this.busy==!0||this.closed||((a.key=="right"||a.key=="left"||a.key=="space")&&a.preventDefault(),this.display.mode!="single"&&(a.key=="right"||a.key=="space"?this.navAux(a,"next"):a.key=="left"&&this.navAux(a,"prev")),a.key=="esc"&&this.display.disappear())}.bind(this))},navAux:function(a,b){if(a)this.pauseAutoPlay();else if(this.busy||!this.fileReady)return;this.busy=!0;var d,e;b=="next"?(d=this.currentIndex!=this.currentGallery.items.length-1?this.currentIndex+=1:this.currentIndex=0,
e=this.currentIndex!=this.currentGallery.items.length-1?this.currentIndex+1:0):(d=this.currentIndex!=0?this.currentIndex-=1:this.currentIndex=this.currentGallery.items.length-1,e=this.currentIndex!=0?this.currentIndex-1:this.currentGallery.items.length-1);this.loadFile(this.currentGallery.get_item(d),[this.currentGallery.get_item(e)])}})})();
var MilkboxDisplay=new Class({Implements:[Options,Events],options:{initialWidth:100,initialHeight:100,overlayOpacity:1,marginTop:0,fileboxBorderWidth:"0px",fileboxBorderColor:"#000000",fileboxPadding:"0px",resizeDuration:0.5,resizeTransition:"sine:in:out",centered:!1,autoSize:!1,autoSizeMaxHeight:0,imageOfText:"of",onNextClick:function(){},onPrevClick:function(){},onPlayPause:function(){},onDisappear:function(){},onResizeComplete:function(){}},initialize:function(b){this.setOptions(b);this.paused=
!1;this.mode="standard";this.ready=!1;this.current_file=null;this.build_html();this.prepare_effects();this.prepare_events()},build_html:function(){this.overlay=(new Element("div",{id:"mbox-overlay",styles:{visibility:"visible",position:"fixed",display:"none",left:0,width:"100%",opacity:0,height:0,overflow:"hidden",margin:0,padding:0}})).inject($(document.body));this.mainbox=(new Element("div",{id:"mbox-mainbox",styles:{position:this.options.centered?"fixed":"absolute",overflow:"hidden",display:"none",
"z-index":50001,width:this.options.initialWidth,height:this.options.initialHeight,opacity:0,margin:0,left:"50%",marginLeft:-(this.options.initialWidth/2),marginTop:this.options.centered?-(this.options.initialHeight/2):"",top:this.options.centered?"50%":""}})).inject($(document.body));this.filebox=(new Element("div",{id:"mbox-filebox",styles:{"border-style":"solid","border-width":this.options.fileboxBorderWidth,"border-color":this.options.fileboxBorderColor,padding:this.options.fileboxPadding,opacity:0}})).inject(this.mainbox);
this.bottom=(new Element("div#mbox-bottom")).setStyle("visibility","hidden").inject(this.mainbox);this.controls=new Element("div#mbox-controls");this.caption=(new Element("div#mbox-caption",{html:"test"})).setStyle("display","none");this.bottom.adopt(new Element("div.mbox-reset"),this.controls,this.caption,new Element("div.mbox-reset"));this.close=new Element("div#mbox-close");this.next=new Element("div#mbox-next");this.prev=new Element("div#mbox-prev");this.playpause=new Element("div#mbox-playpause");
this.count=new Element("div#mbox-count");$$(this.next,this.prev,this.close,this.playpause).setStyles({outline:"none",cursor:"pointer"});this.controls.adopt(new Element("div.mbox-reset"),this.close,this.next,this.prev,this.playpause,new Element("div.mbox-reset"),this.count)},prepare_effects:function(){this.overlay_show_fx=new Fx.Tween(this.overlay,{duration:"short",link:"cancel",property:"opacity",onStart:function(){this.element.setStyles({top:-window.getScroll().y,height:window.getScrollSize().y+
window.getScroll().y,display:"block"})},onComplete:function(){this.mainbox_show_fx.start(1)}.bind(this)});this.overlay_hide_fx=new Fx.Tween(this.overlay,{duration:"short",link:"cancel",property:"opacity",onStart:function(){},onComplete:function(){this.overlay.setStyle("display","none");this.fireEvent("disappear")}.bind(this)});this.mainbox_show_fx=new Fx.Tween(this.mainbox,{duration:"short",link:"cancel",property:"opacity",onStart:function(){this.mainbox.setStyle("display","block")}.bind(this),onComplete:function(){this.ready=
!0}.bind(this)});this.mainbox_hide_fx=new Fx.Tween(this.mainbox,{duration:"short",link:"cancel",property:"opacity",onStart:function(){this.ready=!1}.bind(this),onComplete:function(){this.overlay.setStyle("display","none")}.bind(this)});this.mainbox_resize_fx=new Fx.Morph(this.mainbox,{duration:this.options.resizeDuration*1E3,transition:this.options.resizeTransition,link:"cancel",onStart:function(){this.filebox.setStyle("opacity",0)}.bind(this),onComplete:function(){this.show_bottom();this.filebox.setStyle("height",
this.current_file.height+"px");this.filebox.grab(this.current_file).tween("opacity",1);this.fireEvent("resizeComplete")}.bind(this)});this.filebox.set("tween",{duration:"short",link:"chain"})},prepare_events:function(){$$(this.overlay,this.close).addEvent("click",function(){this.disappear()}.bind(this));this.prev.addEvent("click",function(){this.fireEvent("prevClick")}.bind(this));this.next.addEvent("click",function(){this.fireEvent("nextClick")}.bind(this));this.playpause.addEvent("click",function(){this.fireEvent("playPauseClick")}.bind(this))},
show_file:function(b,a,c,d){this.hide_loader();if(b.match&&b.match("img")&&(this.options.autoSize||this.options.centered))b=this.get_resized_image(b);var e={w:b.width.toInt(),h:b.height.toInt()};!e.w||!e.h?alert("Milkbox error: you must pass size values if the file is swf or html or a free file (openWithFile)"):(e=Object.map(e,function(a){return a.toInt()}),this.caption.innerHTML=a?a:"",this.update_count(c,d),c=this.filebox.getStyle("border-width").toInt()*2+this.filebox.getStyle("padding").toInt()*
2,a=e.w+c,d=this.caption.getStyles("paddingRight","marginRight"),this.caption.setStyle("width",a-d.paddingRight.toInt()-d.marginRight.toInt()),$$(this.bottom,this.controls).setStyle("height",Math.max(this.caption.getDimensions().height,this.controls.getComputedSize().totalHeight)),d=this.mainbox.getComputedSize(),e=e.h+c+this.bottom.getComputedSize().totalHeight,e={w:a,h:e,total_w:a+d.totalWidth-d.width,total_h:e+d.totalHeight-d.height},this.current_file=b,this.resize_to(e))},get_resized_image:function(b){var a,
c,d,e={w:b.get("width").toInt(),h:b.get("height").toInt()};a=window.getSize();a={w:a.x-60,h:a.y-68-this.options.marginTop*2};d=Math.max(a.h,a.w);d==a.w?(c=d/e.w,d="h"):(c=d/e.h,d="w");c=c<=1?c:1;e=Object.map(e,function(a){return Math.floor(a*c)});c=a[d]/e[d]<=1?a[d]/e[d]:1;e=Object.map(e,function(a){return Math.floor(a*c)});this.options.autoSizeMaxHeight>0&&(c=this.options.autoSizeMaxHeight/e.height<1?this.options.autoSizeMaxHeight/e.height:1,e=Object.map(e,function(a){return Math.floor(a*c)}));b.set({width:e.w,
height:e.h});return b},resize_to:function(b){this.mainbox_resize_fx.start({width:b.w,height:b.h,marginLeft:-(b.total_w/2).round(),marginTop:this.options.centered?-(b.total_h/2).round():""})},show_loader:function(){this.mainbox.addClass("mbox-loading")},hide_loader:function(){this.mainbox.removeClass("mbox-loading")},clear_content:function(){this.filebox.empty();this.caption.empty();this.count.empty();$$(this.bottom,this.controls).setStyle("height","")},hide_bottom:function(){this.caption.setStyle("display",
"none");this.bottom.setStyle("visibility","hidden")},show_bottom:function(){this.caption.setStyle("display","block");this.bottom.setStyle("visibility","visible")},appear:function(){this.options.centered||this.mainbox.setStyle("top",window.getScroll().y+this.options.marginTop);this.overlay_show_fx.start(this.options.overlayOpacity)},disappear:function(){this.cancel_effects();this.current_file=null;this.ready=!1;this.mode="standard";$$(this.prev,this.next,this.playpause,this.count).setStyle("display",
"none");this.playpause.setStyle("backgroundPosition","0 0");this.count.empty();this.caption.setStyle("display","none").empty();this.bottom.setStyle("visibility","hidden");this.filebox.setStyle("height","").empty();this.mainbox.setStyles({opacity:0,display:"none",width:this.options.initialWidth,height:this.options.initialHeight,marginLeft:-(this.options.initialWidth/2),marginTop:this.options.centered?-(this.options.initialHeight/2):"",top:this.options.centered?"50%":""});this.filebox.setStyle("opacity",
0);this.overlay_hide_fx.start(0)},cancel_effects:function(){[this.mainbox_resize_fx,this.mainbox_hide_fx,this.mainbox_show_fx,this.overlay_hide_fx,this.overlay_show_fx].each(function(b){b.cancel()})},set_mode:function(b){this.mode=b;var a=this.close.getComputedSize().width,c=this.prev.getComputedSize().width,d=this.next.getComputedSize().width,e=this.playpause.getComputedSize().width,f=this.mainbox.getStyle("border-right-width").toInt();switch(b){case "autoplay":$$(this.playpause,this.close,this.next,
this.prev,this.count).setStyle("display","block");this.controls.setStyle("width",a+c+d+e+f);break;case "single":$$(this.playpause,this.next,this.prev,this.count).setStyle("display","none");this.controls.setStyle("width",a+f);break;case "standard":$$(this.close,this.next,this.prev,this.count).setStyle("display","block");this.playpause.setStyle("display","none");this.controls.setStyle("width",a+c+d+f);break;default:return}this.caption.setStyle("margin-right",this.controls.getComputedSize().totalWidth)},
set_paused:function(b){this.paused=b;this.playpause.setStyle("background-position",this.paused?"0 -66px":"")},update_count:function(b,a){this.count.set("text",b+" "+this.options.imageOfText+" "+a)},resetOverlaySize:function(){this.overlay.getStyle("opacity")!=0&&this.overlay.setStyles({height:window.getSize().y})},clear:function(){this.overlay.destroy();this.mainbox.destroy()}}),MilkboxGallery=new Class({Implements:[Options,Events],options:{name:null,autoplay:null,autoplay_delay:null},initialize:function(b,
a){this.setOptions(a);this.source=b;this.external=!1;this.items=null;this.name=this.options.name;this.type=null;this.prepare_gallery();this.prepare_elements()},prepare_gallery:function(){switch(typeOf(this.source)){case "element":this.check_extension(this.source.href)?this.items=[this.source]:alert("Wrong file extension: "+this.source.href);break;case "elements":this.items=this.source.filter(function(b){return this.check_extension(b.href)},this);break;case "array":this.items=this.source.filter(function(b){return this.check_extension(b.href)},
this);this.external=!0;break;default:return}this.items.length==0&&alert("Warning: gallery "+this.name+" is empty")},prepare_elements:function(){this.items=this.items.map(function(b){var a=b.href.split("?"),c={};c.element=typeOf(b)=="element"?b:null;c.href=a[0];c.vars=a[1]?a[1].parseQueryString():null;c.size=null;c.caption=c.element?c.element.get("title"):b.title;if(b=c.element?c.element.get("data-milkbox-size"):b.size)c.size=Object.map(this.get_item_props(b),function(a){return a.toInt()});return c},
this);if(this.items.length!=0)this.type=this.items.length==1?"single":this.options.autoplay?"autoplay":"standard"},check_extension:function(b){return b.split("?")[0].test(/\.(gif|jpg|jpeg|png|swf|html)$/i)},get_index_of:function(b){typeOf(b)=="string"?this.items.indexOf(this.items.filter(function(a){return a.href===b})[0]):this.items.indexOf(b);return this.items.indexOf(b)},get_item:function(b){return this.items[b]},get_item_props:function(b){var a={};b.split(",").each(function(b){b=b.trim().split(":");
a[b[0].trim()]=b[1].trim()},this);return a},refresh:function(){this.type=this.items.length==1?"single":this.options.autoplay?"autoplay":"standard"},clear:function(){this.items=this.source=null}});window.addEvent("domready",function(){milkbox=new Milkbox({centered:!0})});
