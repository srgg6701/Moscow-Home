if(!Request.JSONP)Request.JSONP=new Class({Implements:[Chain,Events,Options],options:{url:"",data:{},retries:0,timeout:0,link:"ignore",callbackKey:"callback",injectScript:document.head},initialize:function(a){this.setOptions(a);this.running=!1;this.requests=0;this.triesRemaining=[]},check:function(){if(!this.running)return!0;switch(this.options.link){case "cancel":return this.cancel(),!0;case "chain":this.chain(this.caller.bind(this,arguments))}return!1},send:function(a,b){if(!$chk(b)&&!this.check(a))return this;
var c=$type(a),e=this.options,d=$chk(b)?b:this.requests++;if(c=="string"||c=="element")a={data:a};a=$extend({data:e.data,url:e.url},a);if(!$chk(this.triesRemaining[d]))this.triesRemaining[d]=this.options.retries;var f=this.triesRemaining[d];(function(){var b=this.getScript(a);this.fireEvent("request",b);this.running=!0;(function(){f?(this.triesRemaining[d]=f-1,b&&(b.destroy(),this.send(a,d).fireEvent("retry",this.triesRemaining[d]))):this.running&&b&&this.options.timeout&&(b.destroy(),this.cancel().fireEvent("failure"))}).delay(this.options.timeout,
this)}).delay(Browser.Engine.trident?50:0,this);return this},cancel:function(){if(!this.running)return this;this.running=!1;this.fireEvent("cancel");return this},getScript:function(a){var b=Request.JSONP.counter,c;Request.JSONP.counter++;switch($type(a.data)){case "element":c=document.id(a.data).toQueryString();break;case "object":case "hash":c=Hash.toQueryString(a.data)}a=a.url+(a.url.test("\\?")?"&":"?")+(a.callbackKey||this.options.callbackKey)+"=Request.JSONP.request_map.request_"+b+(c?"&"+c:
"");var e=new Element("script",{type:"text/javascript",src:a});Request.JSONP.request_map["request_"+b]=function(){this.success(arguments,e)}.bind(this);return e.inject(this.options.injectScript)},success:function(a,b){if(!this.running)return!1;b&&b.destroy();this.running=!1;this.fireEvent("complete",a).fireEvent("success",a).callChain()}}),Request.JSONP.counter=0,Request.JSONP.request_map={};
